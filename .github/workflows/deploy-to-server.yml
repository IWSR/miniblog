name: Deploy to Server

# ä¸“é—¨ç”¨äºŽæœåŠ¡å™¨éƒ¨ç½²çš„å·¥ä½œæµ
# å¯ä»¥æ‰‹åŠ¨è§¦å‘æˆ–åœ¨é•œåƒæž„å»ºå®ŒæˆåŽè‡ªåŠ¨è§¦å‘

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "éƒ¨ç½²çŽ¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "é•œåƒæ ‡ç­¾"
        required: false
        default: "latest"
      deploy_mode:
        description: "éƒ¨ç½²æ¨¡å¼"
        required: true
        default: "mariadb"
        type: choice
        options:
          - memory
          - mariadb
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      deploy_mode:
        required: false
        type: string
        default: "mariadb"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        run: |
          # æ ¹æ®çŽ¯å¢ƒè®¾ç½®æœåŠ¡å™¨ä¿¡æ¯
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "server_host=${{ secrets.PROD_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "server_user=${{ secrets.PROD_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "server_key=${{ secrets.PROD_SERVER_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "server_port=${{ secrets.PROD_SERVER_PORT || '22' }}" >> $GITHUB_OUTPUT
            echo "container_name=miniblog-prod" >> $GITHUB_OUTPUT
            echo "deploy_path=/opt/miniblog-prod" >> $GITHUB_OUTPUT
          else
            echo "server_host=${{ secrets.STAGING_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "server_user=${{ secrets.STAGING_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "server_key=${{ secrets.STAGING_SERVER_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "server_port=${{ secrets.STAGING_SERVER_PORT || '22' }}" >> $GITHUB_OUTPUT
            echo "container_name=miniblog-staging" >> $GITHUB_OUTPUT
            echo "deploy_path=/opt/miniblog-staging" >> $GITHUB_OUTPUT
          fi

          # è®¾ç½®é•œåƒæ ‡ç­¾
          IMAGE_TAG="${{ inputs.image_tag }}"
          if [ -z "$IMAGE_TAG" ] || [ "$IMAGE_TAG" = "latest" ]; then
            IMAGE_TAG="latest"
          fi
          echo "image_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

          # è®¾ç½®éƒ¨ç½²æ¨¡å¼
          DEPLOY_MODE="${{ inputs.deploy_mode }}"
          if [ -z "$DEPLOY_MODE" ]; then
            DEPLOY_MODE="mariadb"
          fi
          echo "deploy_mode=$DEPLOY_MODE" >> $GITHUB_OUTPUT

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.vars.outputs.server_host }}
          username: ${{ steps.vars.outputs.server_user }}
          key: ${{ steps.vars.outputs.server_key }}
          port: ${{ steps.vars.outputs.server_port }}
          script: |
            set -e

            echo "=========================================="
            echo "ðŸš€ MiniBlog è‡ªåŠ¨éƒ¨ç½²å¼€å§‹"
            echo "=========================================="
            echo "çŽ¯å¢ƒ: ${{ inputs.environment }}"
            echo "æ¨¡å¼: ${{ steps.vars.outputs.deploy_mode }}"
            echo "é•œåƒ: ${{ steps.vars.outputs.image_tag }}"
            echo "å®¹å™¨: ${{ steps.vars.outputs.container_name }}"
            echo "è·¯å¾„: ${{ steps.vars.outputs.deploy_path }}"
            echo ""

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            echo "ðŸ“ åˆ›å»ºéƒ¨ç½²ç›®å½•..."
            mkdir -p ${{ steps.vars.outputs.deploy_path }}
            cd ${{ steps.vars.outputs.deploy_path }}

            # ç™»å½•åˆ°GitHub Container Registry
            echo "ðŸ” ç™»å½•å®¹å™¨æ³¨å†Œè¡¨..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ðŸ“¦ æ‹‰å–Dockeré•œåƒ..."
            docker pull ${{ steps.vars.outputs.image_tag }}

            # æ ¹æ®éƒ¨ç½²æ¨¡å¼æ‰§è¡Œä¸åŒçš„éƒ¨ç½²ç­–ç•¥
            if [ "${{ steps.vars.outputs.deploy_mode }}" = "mariadb" ]; then
              echo "ðŸ—„ï¸  æ‰§è¡ŒMariaDBæ¨¡å¼éƒ¨ç½²..."
              
              # åˆ›å»ºç½‘ç»œ
              docker network create miniblog-network-${{ inputs.environment }} 2>/dev/null || true
              
              # å¯åŠ¨MariaDBï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
              DB_CONTAINER="miniblog-mariadb-${{ inputs.environment }}"
              if ! docker ps | grep -q $DB_CONTAINER; then
                echo "ðŸ—„ï¸  å¯åŠ¨MariaDBå®¹å™¨..."
                docker run -d \
                  --name $DB_CONTAINER \
                  --network miniblog-network-${{ inputs.environment }} \
                  -e MYSQL_ROOT_PASSWORD=root123456 \
                  -e MYSQL_DATABASE=miniblog \
                  -e MYSQL_USER=miniblog \
                  -e MYSQL_PASSWORD=miniblog1234 \
                  -p ${{ inputs.environment == 'production' && '3306' || '3307' }}:3306 \
                  -v miniblog-db-data-${{ inputs.environment }}:/var/lib/mysql \
                  --restart unless-stopped \
                  mariadb:10.11
                
                echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
                sleep 30
                
                # ç­‰å¾…æ•°æ®åº“å°±ç»ª
                for i in {1..60}; do
                  if docker exec $DB_CONTAINER mysqladmin ping -h localhost -u root -proot123456 --silent; then
                    echo "âœ… æ•°æ®åº“å·²å°±ç»ª"
                    break
                  fi
                  if [ $i -eq 60 ]; then
                    echo "âŒ æ•°æ®åº“å¯åŠ¨è¶…æ—¶"
                    exit 1
                  fi
                  sleep 1
                done
              else
                echo "âœ… MariaDBå®¹å™¨å·²å­˜åœ¨"
              fi
              
              # åœæ­¢æ—§çš„åº”ç”¨å®¹å™¨
              echo "ðŸ›‘ åœæ­¢æ—§çš„åº”ç”¨å®¹å™¨..."
              docker stop ${{ steps.vars.outputs.container_name }} 2>/dev/null || true
              docker rm ${{ steps.vars.outputs.container_name }} 2>/dev/null || true
              
              # åˆ›å»ºMariaDBæ¨¡å¼é…ç½®æ–‡ä»¶
              echo "ðŸ“ åˆ›å»ºMariaDBé…ç½®æ–‡ä»¶..."
              cat > mb-apiserver.yaml << 'EOF'
            server-mode: grpc-gateway
            jwt-key: Rtg8BPKNEf2mB4mgvKONGPZZQSaJWNLijxR42qRgq0iBb5
            expiration: 2h
            enable-memory-store: false
            tls:
              use-tls: false
            http:
              addr: :5555
            grpc:
              addr: :6666
            mysql:
              addr: miniblog-mariadb-${{ inputs.environment }}:3306
              username: miniblog
              password: miniblog1234
              database: miniblog
              max-idle-connections: 50
              max-open-connections: 100
              max-connection-life-time: 10s
              log-level: 2
            log:
              disable-caller: false
              disable-stacktrace: false
              level: ${{ inputs.environment == 'production' && 'info' || 'debug' }}
              format: json
              output-paths: [stdout]
            EOF
              
              # å¯åŠ¨åº”ç”¨å®¹å™¨
              echo "ðŸš€ å¯åŠ¨åº”ç”¨å®¹å™¨..."
              docker run -d \
                --name ${{ steps.vars.outputs.container_name }} \
                --network miniblog-network-${{ inputs.environment }} \
                -p ${{ inputs.environment == 'production' && '5555' || '5556' }}:5555 \
                -p ${{ inputs.environment == 'production' && '6666' || '6667' }}:6666 \
                -v $(pwd)/mb-apiserver.yaml:/opt/miniblog/configs/mb-apiserver.yaml \
                --restart unless-stopped \
                ${{ steps.vars.outputs.image_tag }} \
                --config=/opt/miniblog/configs/mb-apiserver.yaml
                
            else
              echo "ðŸ’¾ æ‰§è¡Œå†…å­˜æ•°æ®åº“æ¨¡å¼éƒ¨ç½²..."
              
              # åœæ­¢æ—§å®¹å™¨
              echo "ðŸ›‘ åœæ­¢æ—§å®¹å™¨..."
              docker stop ${{ steps.vars.outputs.container_name }} 2>/dev/null || true
              docker rm ${{ steps.vars.outputs.container_name }} 2>/dev/null || true
              
              # åˆ›å»ºå†…å­˜æ•°æ®åº“æ¨¡å¼é…ç½®æ–‡ä»¶
              echo "ðŸ“ åˆ›å»ºå†…å­˜æ•°æ®åº“é…ç½®æ–‡ä»¶..."
              cat > mb-apiserver.yaml << 'EOF'
            server-mode: grpc-gateway
            jwt-key: Rtg8BPKNEf2mB4mgvKONGPZZQSaJWNLijxR42qRgq0iBb5
            expiration: 2h
            enable-memory-store: true
            tls:
              use-tls: false
            http:
              addr: :5555
            grpc:
              addr: :6666
            log:
              disable-caller: false
              disable-stacktrace: false
              level: ${{ inputs.environment == 'production' && 'info' || 'debug' }}
              format: json
              output-paths: [stdout]
            EOF
              
              # å¯åŠ¨å®¹å™¨
              echo "ðŸš€ å¯åŠ¨åº”ç”¨å®¹å™¨..."
              docker run -d \
                --name ${{ steps.vars.outputs.container_name }} \
                -p ${{ inputs.environment == 'production' && '5555' || '5556' }}:5555 \
                -p ${{ inputs.environment == 'production' && '6666' || '6667' }}:6666 \
                -v $(pwd)/mb-apiserver.yaml:/opt/miniblog/configs/mb-apiserver.yaml \
                --restart unless-stopped \
                ${{ steps.vars.outputs.image_tag }} \
                --config=/opt/miniblog/configs/mb-apiserver.yaml
            fi

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15

            # å¥åº·æ£€æŸ¥
            echo "ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            HEALTH_PORT=${{ inputs.environment == 'production' && '5555' || '5556' }}

            for i in {1..30}; do
              if curl -f http://localhost:$HEALTH_PORT/healthz; then
                echo ""
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
                echo "ðŸŒ è®¿é—®åœ°å€: http://$(curl -s ifconfig.me 2>/dev/null || echo 'YOUR_SERVER_IP'):$HEALTH_PORT"
                break
              fi
              if [ $i -eq 30 ]; then
                echo ""
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š"
                docker logs --tail 20 ${{ steps.vars.outputs.container_name }}
                exit 1
              fi
              echo -n "."
              sleep 2
            done

            echo ""
            echo "=========================================="
            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
            echo "å®¹å™¨çŠ¶æ€:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep miniblog

            echo ""
            echo "ðŸ“Š èµ„æºä½¿ç”¨:"
            docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | grep miniblog

      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **çŽ¯å¢ƒ**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æ¨¡å¼**: ${{ steps.vars.outputs.deploy_mode }}" >> $GITHUB_STEP_SUMMARY
            echo "- **é•œåƒ**: ${{ steps.vars.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **å®¹å™¨**: ${{ steps.vars.outputs.container_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.environment }}" = "production" ]; then
              echo "- HTTP API: http://your-server:5555" >> $GITHUB_STEP_SUMMARY
              echo "- gRPC API: your-server:6666" >> $GITHUB_STEP_SUMMARY
            else
              echo "- HTTP API: http://your-server:5556" >> $GITHUB_STEP_SUMMARY
              echo "- gRPC API: your-server:6667" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å’ŒæœåŠ¡å™¨é…ç½®ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

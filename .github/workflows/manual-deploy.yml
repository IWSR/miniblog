name: Manual Deploy

# æ‰‹åŠ¨è§¦å‘çš„éƒ¨ç½²å·¥ä½œæµ
# å¯ä»¥é€‰æ‹©éƒ¨ç½²åˆ°ä¸åŒçš„çŽ¯å¢ƒ

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "é•œåƒæ ‡ç­¾ (ç•™ç©ºä½¿ç”¨latest)"
        required: false
        default: "latest"
      deploy_mode:
        description: "éƒ¨ç½²æ¨¡å¼"
        required: true
        default: "memory"
        type: choice
        options:
          - memory
          - mariadb

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "server_host=${{ secrets.PROD_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "server_user=${{ secrets.PROD_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "server_key=${{ secrets.PROD_SERVER_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "server_port=${{ secrets.PROD_SERVER_PORT }}" >> $GITHUB_OUTPUT
          else
            echo "server_host=${{ secrets.STAGING_SERVER_HOST }}" >> $GITHUB_OUTPUT
            echo "server_user=${{ secrets.STAGING_SERVER_USER }}" >> $GITHUB_OUTPUT
            echo "server_key=${{ secrets.STAGING_SERVER_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "server_port=${{ secrets.STAGING_SERVER_PORT }}" >> $GITHUB_OUTPUT
          fi

          IMAGE_TAG="${{ github.event.inputs.image_tag }}"
          if [ "$IMAGE_TAG" = "latest" ] || [ -z "$IMAGE_TAG" ]; then
            IMAGE_TAG="latest"
          fi
          echo "image_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.vars.outputs.server_host }}
          username: ${{ steps.vars.outputs.server_user }}
          key: ${{ steps.vars.outputs.server_key }}
          port: ${{ steps.vars.outputs.server_port }}
          script: |
            set -e

            echo "ðŸš€ å¼€å§‹éƒ¨ç½² MiniBlog"
            echo "çŽ¯å¢ƒ: ${{ github.event.inputs.environment }}"
            echo "æ¨¡å¼: ${{ github.event.inputs.deploy_mode }}"
            echo "é•œåƒ: ${{ steps.vars.outputs.image_tag }}"

            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p /opt/miniblog
            cd /opt/miniblog

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ðŸ“¦ æ‹‰å–Dockeré•œåƒ..."
            docker pull ${{ steps.vars.outputs.image_tag }}

            # æ ¹æ®éƒ¨ç½²æ¨¡å¼é€‰æ‹©ä¸åŒçš„éƒ¨ç½²æ–¹å¼
            if [ "${{ github.event.inputs.deploy_mode }}" = "mariadb" ]; then
              echo "ðŸ—„ï¸  éƒ¨ç½²MariaDBæ¨¡å¼..."
              
              # åˆ›å»ºç½‘ç»œï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
              docker network create miniblog-network 2>/dev/null || true
              
              # å¯åŠ¨MariaDBï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
              if ! docker ps | grep -q miniblog-mariadb; then
                echo "å¯åŠ¨MariaDBå®¹å™¨..."
                docker run -d \
                  --name miniblog-mariadb \
                  --network miniblog-network \
                  -e MYSQL_ROOT_PASSWORD=root123456 \
                  -e MYSQL_DATABASE=miniblog \
                  -e MYSQL_USER=miniblog \
                  -e MYSQL_PASSWORD=miniblog1234 \
                  -p 3306:3306 \
                  -v miniblog-db-data:/var/lib/mysql \
                  --restart unless-stopped \
                  mariadb:10.11
                
                # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
                echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
                sleep 30
              fi
              
              # åœæ­¢æ—§çš„åº”ç”¨å®¹å™¨
              docker stop miniblog-app-${{ github.event.inputs.environment }} 2>/dev/null || true
              docker rm miniblog-app-${{ github.event.inputs.environment }} 2>/dev/null || true
              
              # åˆ›å»ºé…ç½®æ–‡ä»¶
              cat > mb-apiserver.yaml << 'EOF'
            server-mode: grpc-gateway
            jwt-key: Rtg8BPKNEf2mB4mgvKONGPZZQSaJWNLijxR42qRgq0iBb5
            expiration: 2h
            enable-memory-store: false
            tls:
              use-tls: false
            http:
              addr: :5555
            grpc:
              addr: :6666
            mysql:
              addr: miniblog-mariadb:3306
              username: miniblog
              password: miniblog1234
              database: miniblog
              max-idle-connections: 50
              max-open-connections: 100
              max-connection-life-time: 10s
              log-level: 2
            log:
              disable-caller: false
              disable-stacktrace: false
              level: info
              format: json
              output-paths: [stdout]
            EOF
              
              # å¯åŠ¨åº”ç”¨å®¹å™¨
              docker run -d \
                --name miniblog-app-${{ github.event.inputs.environment }} \
                --network miniblog-network \
                -p 5555:5555 \
                -p 6666:6666 \
                -v $(pwd)/mb-apiserver.yaml:/opt/miniblog/configs/mb-apiserver.yaml \
                --restart unless-stopped \
                ${{ steps.vars.outputs.image_tag }} \
                --config=/opt/miniblog/configs/mb-apiserver.yaml
                
            else
              echo "ðŸ’¾ éƒ¨ç½²å†…å­˜æ•°æ®åº“æ¨¡å¼..."
              
              # åœæ­¢æ—§å®¹å™¨
              docker stop miniblog-${{ github.event.inputs.environment }} 2>/dev/null || true
              docker rm miniblog-${{ github.event.inputs.environment }} 2>/dev/null || true
              
              # åˆ›å»ºé…ç½®æ–‡ä»¶
              cat > mb-apiserver.yaml << 'EOF'
            server-mode: grpc-gateway
            jwt-key: Rtg8BPKNEf2mB4mgvKONGPZZQSaJWNLijxR42qRgq0iBb5
            expiration: 2h
            enable-memory-store: true
            tls:
              use-tls: false
            http:
              addr: :5555
            grpc:
              addr: :6666
            log:
              disable-caller: false
              disable-stacktrace: false
              level: info
              format: json
              output-paths: [stdout]
            EOF
              
              # å¯åŠ¨å®¹å™¨
              docker run -d \
                --name miniblog-${{ github.event.inputs.environment }} \
                -p 5555:5555 \
                -p 6666:6666 \
                -v $(pwd)/mb-apiserver.yaml:/opt/miniblog/configs/mb-apiserver.yaml \
                --restart unless-stopped \
                ${{ steps.vars.outputs.image_tag }} \
                --config=/opt/miniblog/configs/mb-apiserver.yaml
            fi

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10

            # å¥åº·æ£€æŸ¥
            echo "ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..30}; do
              if curl -f http://localhost:5555/healthz; then
                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
                exit 1
              fi
              sleep 2
            done

            echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "è®¿é—®åœ°å€: http://$(curl -s ifconfig.me):5555"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **çŽ¯å¢ƒ**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼**: ${{ github.event.inputs.deploy_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: ${{ steps.vars.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- HTTP API: http://your-server:5555" >> $GITHUB_STEP_SUMMARY
          echo "- å¥åº·æ£€æŸ¥: http://your-server:5555/healthz" >> $GITHUB_STEP_SUMMARY
